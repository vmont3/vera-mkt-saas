generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  govbrSub     String?  @unique
  password     String
  kycStatus    String   @default("pending")
  createdAt    DateTime @default(now())
  wallet       Wallet?
}

model Subject {
  id             String   @id @default(uuid())
  type           String
  ownerId        String
  publicMetadata Json?
  privacyPolicy  Json?
  createdAt      DateTime @default(now())
}

model Tag {
  id            String   @id
  chipUid       String
  hTrunc        String
  integrityCode String
  subjectId     String?
  status        String    @default("pending")
  createdAt     DateTime  @default(now())
}

model QrToken {
  id          String   @id @default(uuid())
  subjectId   String
  token       String   @unique
  expiresAt   DateTime
  status      String   @default("active")
}

model NFCTag {
  id                  String   @id @default(uuid())
  uid                 String   @unique
  hTrunc              String
  integrityCode       String
  counter             Int      @default(0)
  verificationCounter Int      @default(0)
  linkedSubjectId     String?
  linkedAssetId       String?
  anchorTxId          String?
  status              String   @default("active")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model Wallet {
  id             String   @id @default(uuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id])
  creditsBalance Float    @default(0)
  moneyPending   Float    @default(0)
  moneyAvailable Float    @default(0)
}

model OfflineEvent {
  id         String   @id @default(uuid())
  subjectId  String
  rawPayload Json
  status     String   @default("pending")
  createdAt  DateTime @default(now())
}

model LifecycleEvent {
  id             String   @id @default(uuid())
  subjectId      String
  eventType      String
  merkleLeafHash String
  anchorTxid     String?
  createdAt      DateTime @default(now())
}

model ContractTemplate {
  id           String   @id @default(uuid())
  segment      String
  version      String
  templateText String
  createdAt    DateTime @default(now())
}

model Contract {
  id         String   @id @default(uuid())
  templateId String
  filledData Json
  anchorTxid String?
  createdAt  DateTime @default(now())
}

model Delegation {
  id          String   @id @default(uuid())
  ownerId     String
  delegateId  String
  scope       String
  expiresAt   DateTime?
  createdAt   DateTime @default(now())
}

model AuditLog {
  id         String   @id @default(uuid())
  actorId    String
  action     String
  details    Json?
  createdAt  DateTime @default(now())
}

// --- Universal Partner Module Models ---

model Partner {
  id             String            @id @default(uuid())
  name           String
  slug           String            @unique // e.g., "e-recycle"
  segment        String            // "recycle", "benefits", etc.
  isActive       Boolean           @default(true)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  
  config         PartnerConfig?
  apiKeys        PartnerApiKey[]
  assets         PartnerAsset[]
  events         PartnerEvent[]
  batches        PartnerBatch[]
  signatures     PartnerSignature[]
  webhooks       PartnerWebhook[]
  audits         PartnerAudit[]
}

model PartnerApiKey {
  id                 String    @id @default(uuid())
  partnerId          String
  partner            Partner   @relation(fields: [partnerId], references: [id])
  keyHash            String    @unique
  scopes             Json?     // ["read", "write", "admin"]
  rateLimitPerMinute Int       @default(60)
  isActive           Boolean   @default(true)
  lastUsedAt         DateTime?
  createdAt          DateTime  @default(now())
}

model PartnerConfig {
  id             String   @id @default(uuid())
  partnerId      String   @unique
  partner        Partner  @relation(fields: [partnerId], references: [id])
  
  // JSON configuration for dynamic behavior
  // Includes: assetSchema, lifecycle, partnerRules, pricingRules, anchoringRules, signatureRules, webhookRules, riskRules
  config         Json
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model PartnerAsset {
  id             String   @id @default(uuid())
  partnerId      String
  partner        Partner  @relation(fields: [partnerId], references: [id])
  
  externalId     String?  // ID in the partner's system
  type           String   // "electronic", "glass", "pet", etc.
  status         String   // Dynamic based on lifecycle, e.g., "discardStarted", "anchored"
  
  metadata       Json     // Flexible data: weight, serial, purity, photos, etc.
  
  ownerId        String?  // User ID if applicable
  
  batchId        String?
  batch          PartnerBatch? @relation(fields: [batchId], references: [id])
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  events         PartnerEvent[]
  signatures     PartnerSignature[]
}

model PartnerEvent {
  id             String   @id @default(uuid())
  partnerId      String
  partner        Partner  @relation(fields: [partnerId], references: [id])
  
  eventType      String   // "onAssetRegistered", "onOwnershipTransferred", etc.
  payload        Json
  
  assetId        String?
  asset          PartnerAsset? @relation(fields: [assetId], references: [id])
  
  processed      Boolean  @default(false)
  processedAt    DateTime?
  
  createdAt      DateTime @default(now())
}

model PartnerBatch {
  id             String   @id @default(uuid())
  partnerId      String
  partner        Partner  @relation(fields: [partnerId], references: [id])
  
  status         String   // "OPEN", "CLOSED", "ANCHORED"
  itemsCount     Int      @default(0)
  
  anchoredHash   String?
  blockchainTxId String?
  
  assets         PartnerAsset[]
  
  createdAt      DateTime @default(now())
  closedAt       DateTime?
  anchoredAt     DateTime?
}

model PartnerSignature {
  id             String   @id @default(uuid())
  partnerId      String
  partner        Partner  @relation(fields: [partnerId], references: [id])
  
  assetId        String
  asset          PartnerAsset @relation(fields: [assetId], references: [id])
  
  signerId       String?  // User ID or External ID
  type           String   // "terminal", "app", "govbr"
  status         String   // "requested", "pending", "completed", "declined"
  
  signatureData  Json?    // Raw signature data, proof, etc.
  
  requestedAt    DateTime @default(now())
  signedAt       DateTime?
}

model PartnerWebhook {
  id             String   @id @default(uuid())
  partnerId      String
  partner        Partner  @relation(fields: [partnerId], references: [id])
  
  url            String
  secret         String?
  eventTypes     Json     // Array of strings
  isActive       Boolean  @default(true)
  
  createdAt      DateTime @default(now())
}

model PartnerAudit {
  id             String   @id @default(uuid())
  partnerId      String
  partner        Partner  @relation(fields: [partnerId], references: [id])
  
  action         String
  actor          String?
  details        Json?
  
  createdAt      DateTime @default(now())
}
